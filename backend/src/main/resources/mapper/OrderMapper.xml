<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ceramic.mall.mapper.OrderMapper">

    <!-- 根据订单号查询订单 -->
    <select id="selectByOrderNo" resultType="com.ceramic.mall.entity.Order">
        SELECT * FROM orders
        WHERE order_no = #{orderNo}
          AND deleted = 0
    </select>

    <!-- 分页查询用户订单列表，包含订单详情 -->
    <select id="selectOrderPage" resultMap="OrderWithItemsResult">
        SELECT
            o.id,
            o.order_no,
            o.user_id,
            o.total_amount,
            o.status,
            o.address,
            o.phone,
            o.receiver,
            o.pay_time,
            o.ship_time,
            o.complete_time,
            o.create_time
        FROM orders o
        <where>
            o.deleted = 0
            <if test="userId != null">
                AND o.user_id = #{userId}
            </if>
            <if test="status != null">
                AND o.status = #{status}
            </if>
        </where>
        ORDER BY o.create_time DESC
    </select>

    <!-- 结果映射 -->
    <resultMap id="OrderWithItemsResult" type="com.ceramic.mall.entity.Order">
        <id column="id" property="id"/>
        <result column="order_no" property="orderNo"/>
        <result column="user_id" property="userId"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="status" property="status"/>
        <result column="address" property="address"/>
        <result column="phone" property="phone"/>
        <result column="receiver" property="receiver"/>
        <result column="pay_time" property="payTime"/>
        <result column="ship_time" property="shipTime"/>
        <result column="complete_time" property="completeTime"/>
        <result column="create_time" property="createTime"/>
        <collection property="orderItems" ofType="com.ceramic.mall.entity.OrderItem"
                    select="com.ceramic.mall.mapper.OrderItemMapper.selectByOrderId"
                    column="id"/>
    </resultMap>

</mapper>